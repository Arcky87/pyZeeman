# pyZeeman

Пайплайн для обработки двумерных астрономических спектров, полученных с образ-срезателя и анализатора круговой поляризации (ОЗСП).

## Описание

pyZeeman предназначен для полной обработки спектров с ОЗСП от сырых 2D изображений до откалиброванных одномерных спектров с разделением на два ортогональных поляризованных луча.

## Возможности

- Автоматическая сортировка кадров по типу (BIAS, FLAT, ThAr, объекты)
- Удаление космических частиц (cosmic ray removal)
- Создание мастер-калибровок
- Трассировка 14 спектральных порядков с алгоритмом GETXWD
- Интерактивная калибровка по длинам волн (ThAr)
- Применение 2D дисперсионного решения с учетом искажений
- Объединение порядков в два вектора для ортогональных поляризаций

## Архитектура пайплайна

```
RAW FITS files
    ↓
1. lister.py           → Сортировка по типам
    ↓
2. trimmer.py          → Обрезка области интереса
    ↓
3. list_astroscrappy.py → Удаление космических частиц
    ↓
4. medianer.py         → Мастер-BIAS и мастер-FLAT
    ↓
5. list_subtractor.py  → Вычитание калибровок
    ↓
6. not_so_simple_tracer.py → Трассировка 14 порядков
    ↓
7. thar_calibration.py → Дисперсионное решение (интерактивно)
    ↓
8. apply_calibration.py → Применение калибровки
    ↓
9. combine_orders.py   → Объединение в два вектора
    ↓
РЕЗУЛЬТАТ: file_1.fits, file_2.fits (ортогональные поляризации)
```

## Установка

### Требования

```bash
# Python 3.8+
pip install numpy scipy matplotlib astropy
pip install astroscrappy specutils
```

### Зависимости

- `numpy` - численные вычисления
- `scipy` - научные вычисления и оптимизация
- `matplotlib` - визуализация
- `astropy` - FITS файлы и астрономические вычисления
- `astroscrappy` - удаление космических частиц
- `specutils` - спектроскопические утилиты

## Быстрый старт

### 1. Подготовка данных

Поместите ваши FITS файлы в директорию `RAW/`:

```
/data/Observations/my_observation/
    └── RAW/
        ├── o001.fts
        ├── o002.fts
        └── ...
```

### 2. Настройка конфигурации

Скопируйте пример конфигурации и отредактируйте под ваши нужды:

```bash
cp config_example.json my_config.json
```

Настройте параметры камеры:
- `gain`: Коэффициент усиления (e-/ADU)
- `ron`: Шум считывания (e-)
- `n_orders`: Количество порядков (14 для ОЗСП)
- `trim_area`: Область интереса [x1, x2, y1, y2]

### 3. Запуск автоматической обработки

```bash
python reduce4me_new.py /data/Observations/my_observation --config my_config.json
```

Это выполнит шаги 1-6 автоматически.

### 4. Интерактивная калибровка (Шаг 7)

После автоматической обработки запустите интерактивную калибровку:

```bash
python thar_calibration.py
```

Следуйте инструкциям на экране:
1. Выберите спектр ThAr для калибровки
2. Найдите и идентифицируйте линии в атласе
3. Постройте дисперсионное решение
4. Сохраните результат

### 5. Применение калибровки (Шаг 8)

Для каждого научного спектра:

```bash
python apply_calibration.py \
    REDUCED/science_spectrum.fits \
    TRACED_ORDERS/science_spectrum_traced.json \
    calibration.distortion_model.json \
    CALIBRATED/
```

### 6. Объединение порядков (Шаг 9)

Финальное объединение в два поляризационных вектора:

```bash
python combine_orders.py \
    CALIBRATED/ \
    science_spectrum \
    COMBINED/
```

Результат:
- `science_spectrum_1.fits` - порядки 1-7 (первая поляризация)
- `science_spectrum_2.fits` - порядки 8-14 (вторая поляризация)

## Структура проекта

```
pyZeeman/
├── README.md                  # Этот файл
├── CODE_REVIEW.md             # Детальный code review
├── config_example.json        # Пример конфигурации
├── reduce4me_new.py           # Главный скрипт (новый)
├── reduce4me.py               # Старый скрипт (для PyYAP, не используется)
│
├── lister.py                  # Сортировка кадров
├── trimmer.py                 # Обрезка ROI
├── list_astroscrappy.py       # Удаление космических частиц
├── medianer.py                # Создание мастер-калибровок
├── list_subtractor.py         # Вычитание калибровок
│
├── not_so_simple_tracer.py    # Трассировка порядков (GETXWD)
├── thar_calibration.py        # Интерактивная калибровка
├── apply_calibration.py       # Применение решения
├── combine_orders.py          # Объединение порядков
│
├── loaders.py                 # Утилиты загрузки
├── visualize_trace.py         # Визуализация
└── ...
```

## Детальное описание модулей

### lister.py
Автоматически определяет тип кадров по ключевым словам FITS заголовка или по именам файлов. Создает списки:
- `bias_list.txt` - кадры смещения
- `flat_list.txt` - плоские поля
- `thar_list.txt` - калибровочные лампы ThAr
- `obj_list.txt` - научные объекты

### not_so_simple_tracer.py
Реализует алгоритм GETXWD (из пакета REDUCE) для трассировки спектральных порядков:
- Определение границ порядков по флэт-кадру
- Гауссова аппроксимация профилей
- Аппроксимация трасс полиномами Чебышева
- Сохранение в JSON формат

### thar_calibration.py
Интерактивный режим для построения дисперсионного решения:
- Поиск и фитинг линий гауссианами
- Интерактивная идентификация линий атласа
- Построение полиномиальной модели
- Анализ остатков
- Сохранение WCS параметров

### apply_calibration.py
Применение калибровки с учетом искажений:
- Загрузка 2D дисперсионного решения
- Flux-conserving передискретизация
- Расчет ошибок по формуле ПЗС
- Сохранение в FITS с WCS

### combine_orders.py
Объединение порядков:
- Взвешенное усреднение по потоку
- Разделение на группы (1-7 и 8-14)
- Сохранение финальных векторов

## Параметры конфигурации

```json
{
  "data_path": "/path/to/data",
  "gain": 2.78,                    # Усиление камеры (e-/ADU)
  "ron": 5.6,                      # Шум считывания (e-)
  "n_orders": 14,                  # Количество порядков
  "trim_area": [0, 2048, 0, 2048], # ROI [x1, x2, y1, y2]
  "flip": false,                   # Отразить изображение
  "cosmic_ray_params": {
    "sigclip": 4.5,                # Порог обнаружения (σ)
    "sigfrac": 0.3,                # Доля шума для фильтра
    "objlim": 5.0,                 # Порог объектов
    "niter": 4                     # Число итераций
  },
  "tracer_params": {
    "n_points_for_fit": 10,        # Точки для аппроксимации
    "smooth": true,                # Сглаживание профиля
    "smooth_sigma": 1.0,           # Параметр сглаживания
    "getxwd_gauss": false          # Использовать гауссиану
  }
}
```

## Частые проблемы и решения

### Проблема: "No module named 'astroscrappy'"

```bash
pip install astroscrappy
```

### Проблема: Не найдены спектральные порядки

Проверьте параметры трассировки в конфигурации. Попробуйте:
- Увеличить `smooth_sigma`
- Изменить `n_orders`
- Проверить качество флэт-кадра

### Проблема: Плохая калибровка

- Используйте больше опорных линий (минимум 10-15)
- Проверьте покрытие по всему диапазону длин волн
- Используйте полином подходящей степени (3-5)

## Тестовые данные

Тестовые данные доступны в `/data/Observations/test_pyzeeman/RAW/`

Запуск на тестовых данных:

```bash
python reduce4me_new.py /data/Observations/test_pyzeeman
```

## История изменений

### Версия 2.0 (2025-10-14) - Рефакторинг для pyZeeman
- ✅ Создан новый `reduce4me_new.py` специально для ОЗСП
- ✅ Интеграция с `not_so_simple_tracer.py`
- ✅ Интеграция с `thar_calibration.py`, `apply_calibration.py`, `combine_orders.py`
- ✅ Конфигурационный файл JSON
- ✅ Улучшенное логирование
- ✅ Документация

### Версия 1.0 - Начальная версия
- Базовые модули обработки
- Трассировка и калибровка

## Авторы

- Елисеев Илья (оригинальные модули)
- AI Code Review (рефакторинг 2025)

## Лицензия

GNU General Public License v3.0

## Поддержка

При возникновении вопросов или проблем:
1. Проверьте `CODE_REVIEW.md` для детального анализа
2. Изучите логи в `pyzeeman_pipeline.log`
3. Проверьте конфигурацию в `config_example.json`

## Ссылки

- [REDUCE package](http://www.astro.uu.se/~piskunov/RESEARCH/REDUCE/) - алгоритм GETXWD
- [astroscrappy](https://github.com/astropy/astroscrappy) - удаление космических частиц
- [specutils](https://specutils.readthedocs.io/) - спектроскопические утилиты
